<script>
  const BACKEND_BASE = "https://api.yangliu.studio"; // 不要以 / 结尾

  const $ = (sel) => document.querySelector(sel);
  const show = (el, html="") => { el.classList.remove("hidden"); if (html) el.innerHTML = html; };
  const hide = (el) => { el.classList.add("hidden"); el.innerHTML = ""; };

  const form = $("#skyForm");
  const btn  = $("#submitBtn");
  const out  = $("#result");
  const err  = $("#error");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    hide(out); hide(err);

    const name = $("#name").value.trim();
    const location = $("#location").value.trim();
    const thoughts = $("#thoughts").value.trim();
    const file = $("#file").files[0];
    if (!file) { show(err, "Please choose an image of your sky."); return; }

    const fd = new FormData();
    fd.append("file", file, file.name);
    fd.append("name", name);
    fd.append("location", location);
    fd.append("thoughts", thoughts);

    btn.disabled = true; btn.textContent = "Uploading…";
    try {
      const res = await fetch(`${BACKEND_BASE}/upload`, { method: "POST", body: fd, mode: "cors" });
      if (!res.ok) {
        const t = await res.text().catch(()=> "");
        throw new Error(`Upload failed: ${res.status}${t ? " " + t : ""}`);
      }
      const data = await res.json();
      const cid = data.cid || data.value?.cid || data.Hash;
      if (!cid) throw new Error("No CID returned by backend.");
      const gateway = data.gateway || `https://ipfs.4everland.io/ipfs/${cid}`;

      show(out, `
        <div>✅ <strong>Upload successful!</strong></div>
        <div style="margin-top:6px;"><strong>Name:</strong> ${escapeHtml(name)}</div>
        <div><strong>Location:</strong> ${escapeHtml(location)}</div>
        <div><strong>Thoughts:</strong> ${escapeHtml(thoughts)}</div>
        <div style="margin-top:10px;">
          <div class="cid"><code id="cidText">${cid}</code>
            <button class="copy" onclick="copyCID()">Copy</button>
          </div>
        </div>
        <div style="margin-top:8px;"><a href="${gateway}" target="_blank" rel="noopener">View on IPFS Gateway</a></div>
      `);
      form.reset();
    } catch (e) {
      show(err, String(e.message || e));
    } finally {
      btn.disabled = false; btn.textContent = "Upload to IPFS";
    }
  });

  function copyCID() {
    const el = document.getElementById("cidText");
    navigator.clipboard.writeText(el.textContent).then(() => {
      const b = document.querySelector(".copy");
      b.textContent = "Copied!";
      setTimeout(() => (b.textContent = "Copy"), 1200);
    });
  }
  function escapeHtml(s) {
    return s.replace(/[&<>"']/g, c => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
    }[c]));
  }

  // —— Gallery ——
  const gallery = $("#gallery");
  const loadBtn = $("#loadGalleryBtn");
  let nextToken = null;

  loadBtn.addEventListener("click", () => loadGallery(false));

  async function loadGallery(append=false) {
    try {
      const url = new URL(`${BACKEND_BASE}/list`);
      url.searchParams.set("limit", "12");
      if (append && nextToken) url.searchParams.set("token", nextToken);

      const r = await fetch(url, { mode: "cors" });
      if (!r.ok) throw new Error(`List failed: ${r.status}`);
      const data = await r.json();

      renderItems(data.items || [], append);
      nextToken = data.nextToken;
      if (nextToken) appendLoadMore();
    } catch (e) {
      show(gallery, `<div class="error">Failed to load gallery: ${e.message || e}</div>`);
    }
  }

  function renderItems(items, append=false) {
    if (!append) gallery.innerHTML = "";
    const html = items.map(it => `
      <div class="gallery-item">
        <div style="font-size:13px; color:${'var(--muted)'}; margin-bottom:6px;">
          <strong>${escapeHtml(it.name || "Anonymous")}</strong> — ${escapeHtml(it.location || "Unknown location")}
        </div>
        ${it.gateway ? `<img src="${it.gateway}" alt="sky">` : ""}
        <div style="font-size:13px; color:#d0d0d0; margin-bottom:6px;">${escapeHtml(it.thoughts || "")}</div>
        ${it.cid ? `<div class="cid"><code>${it.cid}</code>
            <a class="copy" href="${it.gateway}" target="_blank" rel="noopener">Open</a>
          </div>` : ""}
      </div>
    `).join("");

    show(gallery);
    gallery.insertAdjacentHTML("beforeend", html);
  }

  function appendLoadMore() {
    const existing = document.getElementById("loadMoreBtn");
    if (existing) existing.remove();
    const btn = document.createElement("button");
    btn.id = "loadMoreBtn";
    btn.textContent = "Load more";
    btn.className = "ghost";
    btn.style.marginTop = "8px";
    btn.onclick = () => loadGallery(true);
    gallery.appendChild(btn);
  }
</script>
